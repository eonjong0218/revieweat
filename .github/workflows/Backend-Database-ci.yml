name: ReviewEat Backend & Database CI

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'docker-compose.yml'
      - 'database/**'
  pull_request:
    branches: [main]
    paths:
      - 'backend/**'
      - 'docker-compose.yml'
      - 'database/**'
  workflow_dispatch:
  schedule:
    - cron: '0 15 * * *'  # ë§¤ì¼ í•œêµ­ ì‹œê°„ ìì •(00:00)ì— ìë™ ì‹¤í–‰

jobs:
  revieweat-backend-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create environment file
        run: |
          cat > backend/.env << 'EOF'
          DATABASE_URL=postgresql://postgres:postgres@db:5432/revieweat
          SECRET_KEY=${{ secrets.SECRET_KEY || 'revieweat-test-secret-key-for-ci-cd-pipeline' }}
          ACCESS_TOKEN_EXPIRE_MINUTES=30
          EOF

      - name: Verify ReviewEat project structure
        run: |
          echo "ğŸ” Verifying ReviewEat project structure..."
          
          # í•„ìˆ˜ íŒŒì¼ë“¤ í™•ì¸
          files_to_check=(
            "docker-compose.yml"
            "backend/Dockerfile"
            "backend/requirements.txt"
            "backend/wait-for-it.sh"
            "backend/app/main.py"
            "backend/app/database.py"
            "backend/app/models.py"
            "backend/app/schemas.py"
            "backend/app/crud.py"
            "backend/app/auth.py"
            "backend/app/config.py"
            "backend/app/dependencies.py"
            "database/init.sql"
          )
          
          for file in "${files_to_check[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file found"
            else
              echo "âŒ $file missing"
              exit 1
            fi
          done
          
          # wait-for-it.sh ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
          chmod +x backend/wait-for-it.sh
          echo "âœ… ReviewEat project structure verified"

      - name: Build and start ReviewEat services
        run: |
          echo "ğŸ³ Building and starting ReviewEat Docker Compose services..."
          docker compose up -d --build
          
          echo "ğŸ“Š Initial container status:"
          docker compose ps

      - name: Wait for PostgreSQL database
        run: |
          echo "â³ Waiting for ReviewEat PostgreSQL database..."
          timeout=180
          elapsed=0
          
          while [ $elapsed -lt $timeout ]; do
            if docker compose exec -T db pg_isready -U postgres -d revieweat; then
              echo "âœ… PostgreSQL is ready after ${elapsed}s!"
              break
            fi
            
            if [ $elapsed -ge $timeout ]; then
              echo "âŒ PostgreSQL failed to be ready after ${timeout}s"
              docker compose logs db
              exit 1
            fi
            
            echo "â³ Waiting for PostgreSQL... (${elapsed}s/${timeout}s)"
            sleep 5
            elapsed=$((elapsed + 5))
          done

      - name: Verify ReviewEat database schema
        run: |
          echo "ğŸ—„ï¸ Verifying ReviewEat database schema..."
          
          # í…Œì´ë¸” ì¡´ì¬ í™•ì¸
          tables=("users" "search_history" "reviews")
          for table in "${tables[@]}"; do
            result=$(docker compose exec -T db psql -U postgres -d revieweat -t -c "
              SELECT EXISTS (
                SELECT FROM information_schema.tables 
                WHERE table_schema = 'public' 
                AND table_name = '$table'
              );
            ")
            
            if [[ "$result" == *"t"* ]]; then
              echo "âœ… Table '$table' exists"
            else
              echo "âŒ Table '$table' missing"
              exit 1
            fi
          done
          
          # ì¸ë±ìŠ¤ í™•ì¸
          echo "ğŸ” Checking ReviewEat database indexes..."
          indexes=$(docker compose exec -T db psql -U postgres -d revieweat -t -c "
            SELECT count(*) FROM pg_indexes WHERE schemaname = 'public';
          ")
          echo "âœ… Found $(echo $indexes | tr -d ' ') indexes in database"
          
          # ì™¸ë˜í‚¤ ê´€ê³„ í™•ì¸
          echo "ğŸ”— Checking foreign key relationships..."
          fk_count=$(docker compose exec -T db psql -U postgres -d revieweat -t -c "
            SELECT count(*) FROM information_schema.table_constraints 
            WHERE constraint_type = 'FOREIGN KEY' AND table_schema = 'public';
          ")
          echo "âœ… Found $(echo $fk_count | tr -d ' ') foreign key constraints"

      - name: Wait for ReviewEat FastAPI backend
        run: |
          echo "â³ Waiting for ReviewEat FastAPI backend..."
          timeout=180
          elapsed=0
          
          while [ $elapsed -lt $timeout ]; do
            if curl -f http://localhost:8000/docs > /dev/null 2>&1; then
              echo "âœ… ReviewEat FastAPI backend is ready after ${elapsed}s!"
              break
            fi
            
            if [ $elapsed -ge $timeout ]; then
              echo "âŒ FastAPI backend failed to be ready after ${timeout}s"
              echo "=== Backend Logs ==="
              docker compose logs backend
              exit 1
            fi
            
            echo "â³ Waiting for FastAPI backend... (${elapsed}s/${timeout}s)"
            sleep 5
            elapsed=$((elapsed + 5))
          done

      - name: Test ReviewEat API endpoints
        run: |
          echo "ğŸ§ª Testing ReviewEat API endpoints..."
          
          # 1. FastAPI docs í˜ì´ì§€ í…ŒìŠ¤íŠ¸
          echo "Testing /docs endpoint..."
          if curl -f http://localhost:8000/docs > /dev/null 2>&1; then
            echo "âœ… /docs endpoint OK - FastAPI is working"
          else
            echo "âŒ /docs endpoint failed"
            exit 1
          fi
          
          # 2. OpenAPI schema í…ŒìŠ¤íŠ¸
          echo "Testing /openapi.json endpoint..."
          openapi_response=$(curl -s http://localhost:8000/openapi.json)
          if echo "$openapi_response" | grep -q "ReviewEat\|User\|Review\|Search"; then
            echo "âœ… /openapi.json contains ReviewEat API schema"
          else
            echo "âŒ /openapi.json schema validation failed"
            exit 1
          fi
          
          # 3. íšŒì›ê°€ì… ì—”ë“œí¬ì¸íŠ¸ êµ¬ì¡° í…ŒìŠ¤íŠ¸
          echo "Testing /register endpoint structure..."
          register_response=$(curl -s -X POST http://localhost:8000/register \
            -H "Content-Type: application/json" \
            -d '{}')
          if echo "$register_response" | grep -q "detail\|field required"; then
            echo "âœ… /register endpoint validation working"
          else
            echo "âš ï¸ /register endpoint response: $register_response"
          fi
          
          # 4. ë¡œê·¸ì¸ ì—”ë“œí¬ì¸íŠ¸ êµ¬ì¡° í…ŒìŠ¤íŠ¸
          echo "Testing /token endpoint structure..."
          token_response=$(curl -s -X POST http://localhost:8000/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "username=test&password=test")
          if echo "$token_response" | grep -q "detail\|Incorrect"; then
            echo "âœ… /token endpoint validation working"
          else
            echo "âš ï¸ /token endpoint response: $token_response"
          fi

      - name: Test ReviewEat database operations
        run: |
          echo "ğŸ—„ï¸ Testing ReviewEat database CRUD operations..."
          
          # 1. ì‚¬ìš©ì ìƒì„± í…ŒìŠ¤íŠ¸
          echo "Testing User CRUD operations..."
          docker compose exec -T db psql -U postgres -d revieweat -c "
            INSERT INTO users (email, username, hashed_password, role) 
            VALUES ('citest@revieweat.com', 'revieweat_ci_user', '\$2b\$12\$test.hash.here', 'user')
            ON CONFLICT (email) DO NOTHING;
          "
          
          user_id=$(docker compose exec -T db psql -U postgres -d revieweat -t -c "
            SELECT id FROM users WHERE email = 'citest@revieweat.com';
          ")
          user_id=$(echo $user_id | tr -d ' ')
          
          if [ ! -z "$user_id" ] && [ "$user_id" != "" ]; then
            echo "âœ… User creation successful (ID: $user_id)"
          else
            echo "âŒ User creation failed"
            exit 1
          fi
          
          # 2. ë¦¬ë·° ìƒì„± í…ŒìŠ¤íŠ¸
          echo "Testing Review CRUD operations..."
          docker compose exec -T db psql -U postgres -d revieweat -c "
            INSERT INTO reviews (user_id, place_name, place_address, review_date, rating, companion, review_text, image_paths) 
            VALUES (
              $user_id,
              'ReviewEat CI í…ŒìŠ¤íŠ¸ ë§›ì§‘', 
              'ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…ŒìŠ¤íŠ¸ë¡œ 123', 
              NOW(), 
              '5', 
              'ë™ë£Œ', 
              'CI í…ŒìŠ¤íŠ¸ìš© ë¦¬ë·°ì…ë‹ˆë‹¤. ReviewEat ì•±ì´ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤!',
              '/uploads/ci_test_image.jpg'
            );
          "
          
          review_count=$(docker compose exec -T db psql -U postgres -d revieweat -t -c "
            SELECT COUNT(*) FROM reviews WHERE user_id = $user_id;
          ")
          
          if [ $(echo $review_count | tr -d ' ') -ge 1 ]; then
            echo "âœ… Review creation successful"
          else
            echo "âŒ Review creation failed"
            exit 1
          fi
          
          # 3. ê²€ìƒ‰ ê¸°ë¡ ìƒì„± í…ŒìŠ¤íŠ¸
          echo "Testing SearchHistory CRUD operations..."
          docker compose exec -T db psql -U postgres -d revieweat -c "
            INSERT INTO search_history (query, is_place, name, user_id) 
            VALUES ('ReviewEat CI ê²€ìƒ‰ í…ŒìŠ¤íŠ¸', true, 'CI í…ŒìŠ¤íŠ¸ ì¥ì†Œ', $user_id);
          "
          
          search_count=$(docker compose exec -T db psql -U postgres -d revieweat -t -c "
            SELECT COUNT(*) FROM search_history WHERE user_id = $user_id;
          ")
          
          if [ $(echo $search_count | tr -d ' ') -ge 1 ]; then
            echo "âœ… SearchHistory creation successful"
          else
            echo "âŒ SearchHistory creation failed"
            exit 1
          fi
          
          # 4. ê´€ê³„ í…Œì´ë¸” ì¡°ì¸ í…ŒìŠ¤íŠ¸
          echo "Testing table relationships..."
          join_result=$(docker compose exec -T db psql -U postgres -d revieweat -t -c "
            SELECT u.username, COUNT(r.id) as review_count, COUNT(s.id) as search_count
            FROM users u
            LEFT JOIN reviews r ON u.id = r.user_id
            LEFT JOIN search_history s ON u.id = s.user_id
            WHERE u.email = 'citest@revieweat.com'
            GROUP BY u.id, u.username;
          ")
          echo "âœ… Table relationships working: $join_result"
          
          # 5. í…ŒìŠ¤íŠ¸ ë°ì´í„° ì •ë¦¬
          echo "Cleaning up test data..."
          docker compose exec -T db psql -U postgres -d revieweat -c "
            DELETE FROM search_history WHERE user_id = $user_id;
            DELETE FROM reviews WHERE user_id = $user_id;
            DELETE FROM users WHERE email = 'citest@revieweat.com';
          "
          echo "âœ… Test data cleanup completed"

      - name: Test ReviewEat file upload structure
        run: |
          echo "ğŸ“ Testing ReviewEat file upload functionality..."
          
          # uploads ë””ë ‰í† ë¦¬ í™•ì¸
          if docker compose exec -T backend test -d "uploads"; then
            echo "âœ… uploads directory exists in backend container"
            docker compose exec -T backend ls -la uploads/ || echo "uploads directory is empty (expected)"
          else
            echo "â„¹ï¸ uploads directory will be created when needed"
          fi
          
          # ì´ë¯¸ì§€ ì²˜ë¦¬ ê´€ë ¨ íŒ¨í‚¤ì§€ í™•ì¸
          echo "ğŸ“· Checking image processing capabilities..."
          docker compose exec -T backend python -c "
          try:
              import PIL
              print('âœ… PIL (Pillow) available for image processing')
          except ImportError:
              print('â„¹ï¸ PIL not installed - images will be stored as-is')
          
          try:
              import os
              print(f'âœ… OS module available for file operations')
          except ImportError:
              print('âŒ OS module not available')
          "

      - name: ReviewEat performance and health check
        run: |
          echo "âš¡ Running ReviewEat performance and health checks..."
          
          # ì»¨í…Œì´ë„ˆ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰
          echo "ğŸ“Š Container resource usage:"
          docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}"
          
          # ë°ì´í„°ë² ì´ìŠ¤ ì„±ëŠ¥ í™•ì¸
          echo "ğŸ—„ï¸ Database performance check:"
          docker compose exec -T db psql -U postgres -d revieweat -c "
            SELECT 
              schemaname,
              tablename,
              n_tup_ins as inserts,
              n_tup_upd as updates,
              n_tup_del as deletes
            FROM pg_stat_user_tables 
            WHERE schemaname = 'public'
            ORDER BY tablename;
          "
          
          # í™œì„± ì—°ê²° ìˆ˜ í™•ì¸
          echo "ğŸ”— Active database connections:"
          docker compose exec -T db psql -U postgres -d revieweat -c "
            SELECT count(*) as active_connections,
                   (SELECT count(*) FROM users) as total_users,
                   (SELECT count(*) FROM reviews) as total_reviews,
                   (SELECT count(*) FROM search_history) as total_searches
            FROM pg_stat_activity 
            WHERE state = 'active';
          "
          
          # ìµœì¢… ì»¨í…Œì´ë„ˆ ìƒíƒœ
          echo "ğŸ¥ Final ReviewEat service status:"
          docker compose ps

      - name: Show detailed logs on failure
        if: failure()
        run: |
          echo "=== ğŸ” REVIEWEAT CI DEBUGGING INFORMATION ==="
          
          echo "=== Container Status ==="
          docker compose ps
          
          echo "=== Backend Container Logs ==="
          docker compose logs backend
          
          echo "=== Database Container Logs ==="
          docker compose logs db
          
          echo "=== Environment Variables Check ==="
          docker compose exec -T backend env | grep -E "(DATABASE_URL|SECRET_KEY)" || echo "Could not read env vars"
          
          echo "=== Network Connectivity ==="
          docker compose exec -T backend ping -c 3 db || echo "Cannot ping database"
          
          echo "=== Database Connection Test ==="
          docker compose exec -T backend python -c "
          import os
          import psycopg2
          try:
              conn = psycopg2.connect(os.getenv('DATABASE_URL'))
              print('âœ… Database connection successful')
              conn.close()
          except Exception as e:
              print(f'âŒ Database connection failed: {e}')
          " || echo "Could not test database connection"

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up ReviewEat CI environment..."
          docker compose down -v
          docker system prune -f
          echo "âœ… ReviewEat CI cleanup completed"
